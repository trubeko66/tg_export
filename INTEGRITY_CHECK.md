# Проверка целостности экспорта

## Описание функциональности

Добавлена автоматическая проверка целостности экспорта при каждом запуске программы. Система анализирует существующие экспорты и докачивает недостающие сообщения без дублирования и с сохранением правильного порядка.

## Как работает

### 1. Проверка при запуске
- При каждом запуске программы автоматически проверяется целостность всех каналов
- Анализируются существующие JSON файлы экспорта
- Определяется диапазон сообщений в канале (первое и последнее сообщение)

### 2. Выявление недостающих сообщений
Система ищет два типа пропусков:

**Новые сообщения:**
- Сообщения, появившиеся после последнего экспорта
- Сравнивается максимальный ID в экспорте с текущим последним сообщением в канале

**Пропуски в середине:**
- Анализируются значительные пропуски (5+ отсутствующих сообщений подряд)
- Проверяется, существуют ли эти сообщения в канале

### 3. Докачка недостающих сообщений
- Получение сообщений батчами по 100 штук для эффективности
- Обработка каждого сообщения с применением фильтров контента
- Преобразование в формат MessageData

### 4. Обновление экспорта
- Объединение существующих и новых сообщений
- Сортировка по ID сообщения (хронологический порядок)
- Удаление дубликатов
- Обновление всех форматов экспорта (JSON, HTML, Markdown)

## Логирование

Процесс проверки целостности подробно логируется:

```
2025-08-27 10:30:15 - INFO - Проверка целостности экспорта для канала: Test Channel
2025-08-27 10:30:16 - INFO - Найдено 150 сообщений в существующем экспорте  
2025-08-27 10:30:17 - INFO - Диапазон сообщений в канале Test Channel: 1-200
2025-08-27 10:30:18 - INFO - Найдено 50 недостающих сообщений в канале Test Channel
2025-08-27 10:30:20 - INFO - Получено 50 недостающих сообщений для Test Channel
2025-08-27 10:30:21 - INFO - Целостность экспорта восстановлена для Test Channel: добавлено 50 сообщений
```

## Уведомления

После проверки всех каналов отправляется сводное уведомление:
- Количество каналов с восстановленной целостностью
- Количество каналов с проблемами
- Общий статус проверки

## Безопасность данных

### Предотвращение дублирования:
- Каждое сообщение проверяется по уникальному ID
- Дубликаты автоматически исключаются при объединении

### Сохранение порядка:
- Сообщения сортируются по ID (хронологический порядок)
- Исходный порядок сообщений всегда сохраняется

### Обработка ошибок:
- Если сообщение не может быть получено, оно пропускается
- Ошибки не прерывают процесс проверки других каналов
- Подробное логирование всех проблем

## Производительность

### Оптимизации:
- Батчевое получение сообщений (до 100 за раз)
- Анализ только значительных пропусков (5+ сообщений)
- Кеширование результатов проверки

### Ограничения:
- Не проверяются медиафайлы (только метаданные)
- Фильтры контента применяются к новым сообщениям
- Обновление HTML/Markdown может занять время для больших каналов

## Настройки

Функция работает автоматически без дополнительных настроек. Поведение можно изменить:

1. **Отключение проверки:** Закомментировать вызов в методе `run()`
2. **Изменение порога пропусков:** Изменить значение `>= 5` в коде
3. **Размер батча:** Изменить `batch_size = 100`

## Результат

В консоли отображается:
- ✅ Восстановлено: X каналов
- ⚠️ Проблемы: Y каналов  
- ✅ Все экспорты актуальны (если проблем нет)

Все изменения автоматически сохраняются и синхронизируются через WebDAV (если настроен).