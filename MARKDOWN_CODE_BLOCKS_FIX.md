# Исправление отображения блоков кода в Markdown

## Проблема

В экспортированных Markdown файлах блоки кода отображались неправильно:

### Было:
```text
\`\`\`$ lsd -lah\`\`\`
Команда: find \. \-type f \-name \"\*.txt\" \-delete
```

### Стало:
```bash
$ lsd -lah
```
```bash
find . -type f -name "*.txt" -delete
```

## Причина проблемы

Функция `_safe_markdown_text()` в файле `exporters.py` экранировала **все** обратные кавычки (\`) символом экранирования, что нарушало синтаксис блоков кода Markdown.

## Решение

### 1. Умная обработка блоков кода

Новая функция `_safe_markdown_text()` теперь:
- **Защищает блоки кода** перед экранированием других символов
- **Сохраняет синтаксис** многострочных (\`\`\`) и однострочных (\`) блоков
- **Восстанавливает** блоки кода после обработки остального текста

### 2. Алгоритм обработки

```python
def _safe_markdown_text(self, text: str) -> str:
    # 1. Найти и защитить все блоки кода
    code_blocks = []
    
    # 2. Заменить на плейсхолдеры (__CODE_BLOCK_0__, __CODE_BLOCK_1__, ...)
    cleaned = re.sub(r'```[\s\S]*?```', protect_multiline_code, cleaned)
    cleaned = re.sub(r'`[^`\n]+`', protect_inline_code, cleaned)
    
    # 3. Экранировать остальные Markdown символы
    safe_replacements = [('*', '\\*'), ('_', '\\_'), ...]
    
    # 4. Восстановить оригинальные блоки кода
    for i, code_block in enumerate(code_blocks):
        cleaned = cleaned.replace(f"__CODE_BLOCK_{i}__", code_block)
```

### 3. HTML экспорт также улучшен

Добавлена функция `_format_html_text()` для правильного отображения кода в HTML:

- **Многострочные блоки**: `<pre><code>...</code></pre>`
- **Однострочные блоки**: `<code>...</code>`
- **Стилизация**: Моноширинный шрифт, фон, рамки

#### CSS стили для кода:
```css
pre {
    background: #f4f4f4;
    padding: 15px;
    border-radius: 5px;
    border-left: 4px solid #007acc;
    font-family: 'Courier New', Consolas, monospace;
}

code {
    background: #f4f4f4;
    padding: 2px 6px;
    border-radius: 3px;
    font-family: 'Courier New', Consolas, monospace;
}
```

## Примеры использования

### Многострочный блок кода:

**В Telegram сообщении:**
```
```bash
#!/bin/bash
echo "Hello World"
ls -la
```
```

**В экспортированном Markdown:**
```bash
#!/bin/bash
echo "Hello World"
ls -la
```

**В экспортированном HTML:**
```html
<pre><code>#!/bin/bash
echo "Hello World"
ls -la</code></pre>
```

### Однострочный код:

**В Telegram сообщении:**
```
Используйте команду `npm install` для установки
```

**В экспортированном Markdown:**
```markdown
Используйте команду `npm install` для установки
```

**В экспортированном HTML:**
```html
Используйте команду <code>npm install</code> для установки
```

## Что исправлено

### ✅ Markdown экспорт:
- Блоки кода отображаются правильно в Markdown редакторах
- Поддерживается синтаксическая подсветка кода
- Сохраняется читаемость в GitHub, Notion, VS Code и других

### ✅ HTML экспорт:
- Красивое отображение блоков кода с подсветкой
- Моноширинный шрифт для лучшей читаемости
- Цветовое выделение блоков кода

### ✅ Совместимость:
- Работает с любыми языками программирования
- Поддерживает вложенные обратные кавычки
- Сохраняет форматирование и отступы

## Результат

Теперь при экспорте сообщений с кодом:

1. **Markdown файлы** корректно отображаются во всех редакторах
2. **HTML файлы** имеют красивую стилизацию кода
3. **JSON файлы** сохраняют оригинальный текст без изменений
4. **Блоки кода** работают как ожидается в специализированных редакторах

### Поддерживаемые форматы кода:

- `` `inline code` `` - однострочный код
- \`\`\`language - многострочные блоки с указанием языка
- \`\`\` - многострочные блоки без языка
- Вложенные конструкции и сложные примеры

Все изменения применяются автоматически при следующем экспорте каналов!