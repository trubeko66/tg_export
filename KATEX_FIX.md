# Исправление KaTeX ошибок в Markdown файлах

## Проблема ✅ РЕШЕНА

**Ошибка**: `KaTeX parse error: Undefined control sequence: \- at position 6: DIR" \̲-̲type f \-mtime …`

**Причина**: KaTeX (система рендеринга математических формул) интерпретировал некоторые символы в Markdown как LaTeX команды, особенно:
- `\-` (экранированный дефис)
- `\+`, `\*` (другие экранированные символы)
- `$...$` (математические формулы)
- `\\alpha`, `\\beta` (LaTeX команды)

## Решение

### 1. Новая функция безопасного Markdown

Создана функция `_safe_markdown_text()` которая:
- Очищает текст от проблемных LaTeX последовательностей
- Применяет минимальное экранирование только критичных символов
- Избегает экранирования символов, вызывающих конфликты с KaTeX

### 2. Улучшенная очистка текста

Обновлена функция `clean_text()` с обработкой KaTeX-проблемных паттернов:
```python
katex_problematic_patterns = [
    (r'\\-', '-'),          # \- заменяем на обычный дефис
    (r'\\\w+', ''),         # Удаляем последовательности типа \command
    (r'\$[^$]*\$', ''),     # Удаляем потенциальные математические формулы
    (r'\\[{}[\]()]', ''),   # Удаляем экранированные скобки
]
```

### 3. Безопасное экранирование

Минимальное экранирование только необходимых символов:
- `*` → `\*` (для выделения жирным)
- `_` → `\_` (для выделения курсивом)
- `` ` `` → `` \` `` (для кода)
- `#` → `\#` (для заголовков)
- `[`, `]` → `\[`, `\]` (для ссылок)

**НЕ экранируются**: дефисы, плюсы, точки и другие символы, вызывающие конфликты с KaTeX.

## Результат

### До исправления:
```markdown
Команда: find \. \-type f \-mtime \+30 \-delete
Формула: \$E\=mc\^2\$ и другие символы \\alpha \\beta
```

### После исправления:
```markdown
Команда: find . -type f -mtime +30 -delete
Формула: E=mc^2 и другие символы alpha beta
```

## Преимущества

✅ **Отсутствие KaTeX ошибок**: Markdown файлы корректно отображаются в системах с KaTeX  
✅ **Сохранение читаемости**: Текст остается понятным и естественным  
✅ **Минимальное экранирование**: Экранируются только критичные символы Markdown  
✅ **Автоматическая обработка**: Все исправления применяются автоматически при экспорте  

## Технические детали

- Функция `_safe_markdown_text()` заменяет `_escape_markdown()` в генерации Markdown
- Обработка применяется к тексту сообщений и названиям каналов
- Сохраняется совместимость с обычными Markdown парсерами
- Исправления не влияют на JSON и HTML экспорт

Теперь Markdown файлы будут корректно отображаться во всех системах, включая те, что используют KaTeX для рендеринга математических формул!