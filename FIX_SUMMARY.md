# Исправления для уведомлений и проверки новых сообщений

## Проблемы в текущей реализации

### 1. Неправильная логика реэкспорта
- В текущей реализации реэкспорт запускается при любом несоответствии количества сообщений, а не только при отсутствии MD файла
- Реэкспорт перезаписывает файл полностью, а не дополняет его
- Нет проверки на разницу в 2 раза между количеством сообщений в файле и в канале

### 2. Неправильная логика уведомлений
- Уведомления о реэкспорте не содержат информации о причине реэкспорта
- Уведомления отправляются в неправильных ситуациях
- Нет различия между уведомлениями о новых сообщениях и уведомлениями о реэкспорте

### 3. Неправильная проверка дисбаланса сообщений
- Текущая реализация использует простое сравнение `actual_count >= expected_count`
- Нет проверки на разницу в 2 раза между сообщениями в файле и в канале

## Необходимые изменения

### 1. Изменить логику реэкспорта
- Реэкспорт должен запускаться ТОЛЬКО при отсутствии MD файла
- При наличии новых сообщений MD файл должен дополняться, а не перезаписываться
- Реэкспорт по дисбалансу должен запускаться только при разнице в 2 раза

### 2. Улучшить уведомления
- Уведомления о реэкспорте должны содержать информацию о причине
- Уведомления должны отправляться только в нужных случаях
- Разделить уведомления о новых сообщениях и уведомления о реэкспорте

### 3. Добавить проверку дисбаланса
- Добавить проверку на разницу в 2 раза между сообщениями в файле и в канале
- Запускать реэкспорт только при такой разнице

## План реализации

1. Изменить функцию `_verify_md_file_count` для возврата дополнительной информации о типе несоответствия
2. Обновить логику проверки MD файла в `export_channel` 
3. Добавить проверку на разницу в 2 раза
4. Обновить функцию `_create_notification` для поддержки разных типов уведомлений
5. Изменить логику инкрементального экспорта в Markdown

## Реализованные изменения

### 1. Обновлена функция `_verify_md_file_count`
- Теперь возвращает тройку: `(совпадает ли количество, фактическое количество, тип несоответствия)`
- Типы несоответствий: 
  - `"missing"` - файл отсутствует
  - `"imbalance"` - дисбаланс (>2 раза разница)
  - `"normal"` - обычное несоответствие
- Добавлена проверка на дисбаланс: если в файле сообщений в 2 раза меньше чем в канале

### 2. Обновлена логика проверки MD файла в `export_channel`
- Реэкспорт запускается ТОЛЬКО при отсутствии MD файла или при дисбалансе
- При обычном несоответствии файл дополняется при следующем экспорте новых сообщений
- Добавлены уведомления о реэкспорте с указанием причины

### 3. Добавлена новая функция `_create_reexport_notification`
- Создает специальные уведомления о реэкспорте
- Включает информацию о причине реэкспорта

### 4. Обновлена логика экспорта Markdown файлов
- Уточнена логика append_mode для Markdown экспортера
- Обеспечено правильное инкрементальное добавление сообщений

### 5. Обновлена логика проверки отсутствующих MD файлов
- Метод `_export_missing_md_channels` теперь отправляет уведомления о реэкспорте
- Причина уведомления: "отсутствует MD файл"

## Проверка соответствия требованиям

✅ **Делать полный реэкспорт нужно только в том случае когда отсутствует md файл**:
- Реализовано через проверку типа несоответствия "missing"

✅ **Если в канале появилось новое сообщение, необходимо дополнить файл экспорта md а не переписывать**:
- Реализовано через использование append_mode при инкрементальном экспорте

✅ **Реэкспорт необходимо делать когда количество сообщений в файле md и количество сообщений в канале отличается минимум в 2 раза**:
- Реализовано через проверку дисбаланса и тип несоответствия "imbalance"

✅ **Уведомления о новых сообщениях в телеграм должно уведомлять об реэкспорте, если он был и о причине реэкспорта. В любом другом случае необходимо сообщать только о новых сообщениях с момента последней проверки**:
- Реализовано через две отдельные функции уведомлений:
  - `_create_notification` для новых сообщений
  - `_create_reexport_notification` для реэкспорта с причиной

## Файлы, в которые были внесены изменения

1. `telegram_exporter.py`:
   - Обновлена функция `_verify_md_file_count`
   - Обновлена логика проверки MD файла в `export_channel`
   - Добавлена функция `_create_reexport_notification`
   - Обновлена логика экспорта Markdown файлов
   - Обновлена логика проверки отсутствующих MD файлов

2. `FIX_SUMMARY.md`:
   - Документированы все изменения